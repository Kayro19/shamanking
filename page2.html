<!DOCTYPE html>
<html lang="en">
<head>
Â  <meta charset="UTF-8"/>
Â  <meta name="viewport" content="width=device-width, initial-scale=1"/>
Â  <title>Dynamic Survey with Admin Control + Emoji Reactions</title>

Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
Â  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

Â  <style>
Â  Â  body { font-family: Arial, sans-serif; padding: 20px; }
Â  Â  .btn { padding: 10px 20px; margin: 5px; border:1px solid #444; background:#eee; cursor:pointer; }
Â  Â  .btn.selected { background:#4CAF50; color:#fff; }
Â  Â  #submit-btn[disabled] { background:#ccc; color:#666; cursor:not-allowed; }
Â  Â  #results { margin-top:30px; padding:15px; background:#f4f4f4; border:1px solid #ccc; white-space:pre-wrap; font-family:monospace; }
Â  Â  .bar { color:#4CAF50; }
Â  Â  .highlight { color:#4CAF50; font-weight:bold; }
Â  Â  .line { border-top:1px solid #ccc; margin:10px 0; }
Â  Â  .question-title { color: green; font-weight: bold; }

Â  Â  .emoji-btn {
Â  Â  Â  font-size: 24px;
Â  Â  Â  padding: 0 5px;
Â  Â  Â  margin: 5px;
Â  Â  Â  background: none;
Â  Â  Â  border: none;
Â  Â  Â  cursor: pointer;
Â  Â  Â  transition: transform 0.2s;
Â  Â  }
Â  Â  .emoji-btn.selected {
Â  Â  Â  transform: scale(1.2);
Â  Â  }
Â  Â  .emoji-btn .count {
Â  Â  Â  font-size: 14px;
Â  Â  Â  margin-left: 5px;
Â  Â  }
Â  Â  
Â  Â  @keyframes emoji-pop {
Â  Â  Â  0% { transform: scale(1); }
Â  Â  Â  50% { transform: scale(1.4); }
Â  Â  Â  100% { transform: scale(1); }
Â  Â  }

Â  Â  .emoji-btn.clicked-animation {
Â  Â  Â  Â  animation: emoji-pop 0.4s ease-in-out;
Â  Â  }

Â  Â  #top-controls-wrapper {
Â  Â  Â  Â  display: flex;
Â  Â  Â  Â  align-items: flex-start;
Â  Â  Â  Â  gap: 20px;
Â  Â  Â  Â  flex-wrap: wrap;
Â  Â  Â  Â  margin-bottom: 20px;
Â  Â  }
Â  Â  #auth-section {
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  }
Â  Â  #admin-panel {
Â  Â  Â  Â  display: none; 
Â  Â  Â  Â  padding: 10px;
Â  Â  Â  Â  border: 1px solid #ccc;
Â  Â  Â  Â  border-radius: 5px;
Â  Â  }
    /* MODIFIED: Changed "button" to "> button" to only select direct children */
Â  Â  #admin-panel > button {
Â  Â  Â  Â  display: block;
Â  Â  Â  Â  margin: 8px 0;
Â  Â  }
Â  Â  #admin-panel div {
Â  Â  Â  Â  margin-top: 8px;
Â  Â  }

Â  Â  /* Star Rating Styles */
Â  Â  #star-rating-container {
Â  Â  Â  Â  margin-top: 30px;
Â  Â  Â  Â  padding: 15px;
Â  Â  Â  Â  background: #f9f9f9;
Â  Â  Â  Â  border: 1px solid #ddd;
Â  Â  }
Â  Â  .star-btn {
Â  Â  Â  Â  color: #ddd;
Â  Â  Â  Â  cursor: pointer;
Â  Â  Â  Â  font-size: 30px;
Â  Â  Â  Â  transition: color 0.2s;
Â  Â  }
Â  Â  .star-btn.hover, .star-btn.selected {
Â  Â  Â  Â  color: #ffc107; /* Gold color */
Â  Â  }
Â  Â  #star-rating-results {
Â  Â  Â  Â  margin-top: 10px;
Â  Â  Â  Â  font-style: italic;
Â  Â  Â  Â  color: #555;
Â  Â  }

Â  </style>
</head>

<body>
Â  <div style="font-size: 14px; color: black; background: yellow; padding: 5px; margin-bottom: 10px;">
Â  Version 0.1.1
</div>
Â  <img src="RInew.jpg" width="350" height="165" />

Â  <div id="top-controls-wrapper">
Â  Â  <div id="auth-section">
Â  Â  Â  <input id="email" type="email" placeholder="Admin Email"/>
Â  Â  Â  <input id="password" type="password" placeholder="Password"/>
Â  Â  Â  <button id="login-btn">Login</button>
Â  Â  Â  <button id="logout-btn" style="display:none;">Logout</button>
Â  Â  Â  <div id="login-message"></div>
Â  Â  </div>
Â  Â  <div id="admin-panel">
Â  Â  Â  <h4>Admin Controls</h4>
Â  Â  Â  <button id="reset-btn">Reset Question Data</button>
Â  Â  Â  <button id="reset-emoji-btn">Reset Emoji Counts</button>
Â  Â  Â  <button id="reset-stars-btn">Reset Star Ratings</button>
Â  Â  Â  <div id="global-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="global-toggle"/> <strong>Enable Submissions</strong></label>
Â  Â  Â  </div>
Â  Â  Â  <div id="emoji-toggle-container">
Â  Â  Â  Â  <label><input type="checkbox" id="emoji-visibility-toggle"/> <strong>Show Emoji Reactions</strong></label>
Â  Â  Â  </div>
Â  Â  Â  <div id="star-toggle-container">
Â  Â  Â  Â  Â  <label><input type="checkbox" id="star-visibility-toggle"/> <strong>Show Star Rating</strong></label>
Â  Â  Â  </div>
Â  Â  Â  <div id="item-count-container">
Â  Â  Â  Â  <label><strong>Questions to Show:</strong></label>
Â  Â  Â  Â  <span style="white-space: nowrap;">
Â  Â  Â  Â  Â  <input type="number" id="item-count-input" min="0" max="100" value="5" style="width: 50px;"/>
Â  Â  Â  Â  Â  <button id="update-item-count">Update</button>
Â  Â  Â  Â  </span>
Â  Â  Â  </div>
Â  Â  </div>
Â  </div>

Â  <div id="emoji-container" style="display:none;">
Â  Â  <div><strong>React with an emoji:</strong></div>
Â  Â  <div id="emoji-options">
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ‘">ğŸ‘ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="â¤ï¸">â¤ï¸ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ˜‚">ğŸ˜‚ <span class="count">0</span></button>
Â  Â  Â  <button class="emoji-btn" data-emoji="ğŸ˜®">ğŸ˜® <span class="count">0</span></button>
Â  Â  </div>
Â  </div>
Â  
Â  <div id="star-rating-container" style="display:none;">
Â  Â  <div><strong>Rate your experience:</strong></div>
Â  Â  <div id="star-options">
Â  Â  Â  Â  <span class="star-btn" data-rating="1">&#9734;</span>
Â  Â  Â  Â  <span class="star-btn" data-rating="2">&#9734;</span>
Â  Â  Â  Â  <span class="star-btn" data-rating="3">&#9734;</span>
Â  Â  Â  Â  <span class="star-btn" data-rating="4">&#9734;</span>
Â  Â  Â  Â  <span class="star-btn" data-rating="5">&#9734;</span>
Â  Â  </div>
Â  Â  <div id="star-rating-results">Loading...</div>
Â  </div>

Â  <div id="survey-container"></div>
Â  <button id="submit-btn">Submit</button>

Â  <div id="results"></div>

Â  <script>
Â  Â  const firebaseConfig = {
Â  Â  Â  apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
Â  Â  Â  authDomain: "shamankingdata.firebaseapp.com",
Â  Â  Â  projectId: "shamankingdata",
Â  Â  Â  storageBucket: "shamankingdata.appspot.com",
Â  Â  Â  messagingSenderId: "757444066890",
Â  Â  Â  appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
Â  Â  };
Â  Â  firebase.initializeApp(firebaseConfig);
Â  Â  const db = firebase.firestore(), auth = firebase.auth();

Â  Â  let isAdmin = false;

Â  Â  function getUserId() {
Â  Â  Â  let uid = localStorage.getItem('userId');
Â  Â  Â  if (!uid) {
Â  Â  Â  Â  uid = 'user_' + Math.random().toString(36).substr(2,9);
Â  Â  Â  Â  localStorage.setItem('userId', uid);
Â  Â  Â  }
Â  Â  Â  return uid;
Â  Â  }
Â  Â  const userId = getUserId();
Â  Â  
Â  Â  // --- UTILITY FUNCTIONS ---
Â  Â  function disableSubmit(text='Already Submitted'){
Â  Â  Â  const btn=document.getElementById('submit-btn');
Â  Â  Â  btn.disabled=true; btn.innerText=text;
Â  Â  }
Â  Â  function enableSubmit(){
Â  Â  Â  const btn=document.getElementById('submit-btn');
Â  Â  Â  btn.disabled=false; btn.innerText='Submit';
Â  Â  }

Â  Â  // --- SURVEY LOGIC ---
Â  Â  async function isSubmissionEnabled(){
Â  Â  Â  const doc = await db.collection('settings').doc('submissionControl').get();
Â  Â  Â  return doc.exists && doc.data().enabled===true;
Â  Â  }
Â  Â  async function checkIfSubmitted(){
Â  Â  Â  const allowed = await isSubmissionEnabled();
Â  Â  Â  if(!allowed){ disableSubmit('Submission Disabled'); return; }
Â  Â  Â  const doc = await db.collection('responses').doc(userId).get();
Â  Â  Â  doc.exists ? disableSubmit() : enableSubmit();
Â  Â  }
Â  Â  function renderSurveyItems(count) {
Â  Â  Â  const container = document.getElementById('survey-container');
Â  Â  Â  const submitBtn = document.getElementById('submit-btn');
Â  Â  Â  container.innerHTML = '';

Â  Â  Â  if (count > 0) {
Â  Â  Â  Â  Â  submitBtn.style.display = 'inline-block';
Â  Â  Â  } else {
Â  Â  Â  Â  Â  submitBtn.style.display = 'none';
Â  Â  Â  }

Â  Â  Â  for (let i = 1; i <= count; i++) {
Â  Â  Â  Â  const div = document.createElement('div');
Â  Â  Â  Â  div.className = 'survey-item';
Â  Â  Â  Â  div.dataset.item = i;
Â  Â  Â  Â  div.innerHTML = `<div class="question-title">Question #${i}</div>
Â  Â  Â  Â  Â  <button class="btn" data-letter="A">A</button> <button class="btn" data-letter="B">B</button>
Â  Â  Â  Â  Â  <button class="btn" data-letter="C">C</button> <button class="btn" data-letter="D">D</button>`;
Â  Â  Â  Â  container.appendChild(div);
Â  Â  Â  }
Â  Â  Â  document.querySelectorAll('.survey-item .btn').forEach(btn => {
Â  Â  Â  Â  btn.addEventListener('click', (e) => {
Â  Â  Â  Â  Â  e.target.parentElement.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
Â  Â  Â  Â  Â  e.target.classList.add('selected');
Â  Â  Â  Â  });
Â  Â  Â  });
Â  Â  }
Â  Â  async function showAggregatedResults() {
Â  Â  Â  const settingsDoc = await db.collection('settings').doc('surveySettings').get();
Â  Â  Â  const visible = (settingsDoc.exists && settingsDoc.data().visibleItems !== undefined) ? settingsDoc.data().visibleItems : 5;
Â  Â  Â  const snapshot = await db.collection('responses').get();
Â  Â  Â  const counts = {};
Â  Â  Â  for (let i = 1; i <= visible; i++) { counts['item' + i] = { A: 0, B: 0, C: 0, D: 0 }; }
Â  Â  Â  snapshot.forEach(doc => {
Â  Â  Â  Â  const ans = doc.data().answers;
Â  Â  Â  Â  Object.entries(ans).forEach(([k, v]) => { if (counts[k]?.[v] !== undefined) counts[k][v]++; });
Â  Â  Â  });
Â  Â  Â  let max = 1;
Â  Â  Â  Object.values(counts).forEach(c => Object.values(c).forEach(v => max = Math.max(max, v)));
Â  Â  Â  let html = '<h3>Results:</h3><pre>';
Â  Â  Â  for (let i = 1; i <= visible; i++) {
Â  Â  Â  Â  const itm = counts['item' + i];
Â  Â  Â  Â  const m = Math.max(...Object.values(itm));
Â  Â  Â  Â  html += `Item ${i}:\n`;
Â  Â  Â  Â  Object.entries(itm).forEach(([ltr, cnt]) => {
Â  Â  Â  Â  Â  const bar = `<span class="bar">${'â–ˆ'.repeat((cnt / max) * 20)}</span>`;
Â  Â  Â  Â  Â  const disp = cnt === m && cnt > 0 ? `<span class="highlight">${ltr}</span>` : ltr;
Â  Â  Â  Â  Â  html += `Â  ${disp}: ${cnt} ${bar}\n`;
Â  Â  Â  Â  });
Â  Â  Â  Â  html += '</pre><div class="line"></div><pre>';
Â  Â  Â  }
Â  Â  Â  document.getElementById('results').innerHTML = html + '</pre>';
Â  Â  }

Â  Â  // --- EMOJI LOGIC ---
Â  Â  async function loadEmojiResults() {
Â  Â  Â  const snap = await db.collection('emojiReactions').get();
Â  Â  Â  const counts = {};
Â  Â  Â  snap.forEach(doc => { counts[doc.data().emoji] = (counts[doc.data().emoji] || 0) + 1; });
Â  Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => {
Â  Â  Â  Â  btn.querySelector('.count').innerText = counts[btn.dataset.emoji] || 0;
Â  Â  Â  });
Â  Â  }
Â  Â  async function checkIfReacted() {
Â  Â  Â  const doc = await db.collection('emojiReactions').doc(userId).get();
Â  Â  Â  if (doc.exists) {
Â  Â  Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => {
Â  Â  Â  Â  Â  btn.dataset.emoji === doc.data().emoji ? btn.classList.add('selected') : btn.disabled = true;
Â  Â  Â  Â  });
Â  Â  Â  }
Â  Â  }
Â  Â  async function handleEmojiClick(e) {
Â  Â  Â  const clickedButton = e.currentTarget;
Â  Â  Â  clickedButton.classList.add('clicked-animation');
Â  Â  Â  clickedButton.addEventListener('animationend', () => clickedButton.classList.remove('clicked-animation'), { once: true });
Â  Â  Â  const doc = await db.collection('emojiReactions').doc(userId).get();
Â  Â  Â  if (doc.exists) return;
Â  Â  Â  await db.collection('emojiReactions').doc(userId).set({
Â  Â  Â  Â  emoji: clickedButton.dataset.emoji,
Â  Â  Â  Â  timestamp: firebase.firestore.FieldValue.serverTimestamp()
Â  Â  Â  });
Â  Â  Â  loadEmojiResults();
Â  Â  Â  checkIfReacted();
Â  Â  }
Â  Â  
Â  Â  // --- STAR RATING LOGIC ---
Â  Â  function updateStarsUI(rating) {
Â  Â  Â  Â  document.querySelectorAll('.star-btn').forEach(star => {
Â  Â  Â  Â  Â  Â  const isSelected = star.dataset.rating <= rating;
Â  Â  Â  Â  Â  Â  star.classList.toggle('selected', isSelected);
Â  Â  Â  Â  Â  Â  star.innerHTML = isSelected ? '&#9733;' : '&#9734;';
Â  Â  Â  Â  });
Â  Â  }
Â  Â  async function loadStarRatingResults() {
Â  Â  Â  Â  const doc = await db.collection('settings').doc('starRatingControl').get();
Â  Â  Â  Â  if (doc.exists && doc.data().totalRatings > 0) {
Â  Â  Â  Â  Â  Â  const { sumOfRatings = 0, totalRatings = 0 } = doc.data();
Â  Â  Â  Â  Â  Â  const avg = (sumOfRatings / totalRatings).toFixed(1);
Â  Â  Â  Â  Â  Â  const avgRounded = Math.round(avg);
Â  Â  Â  Â  Â  Â  document.getElementById('star-rating-results').innerText = `Average: ${avg} (${totalRatings} ratings)`;
Â  Â  Â  Â  Â  Â  if (!document.querySelector('.star-btn[disabled]')) {
Â  Â  Â  Â  Â  Â  Â  Â  Â updateStarsUI(avgRounded);
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  Â document.getElementById('star-rating-results').innerText = 'No ratings yet.';
Â  Â  Â  Â  Â  Â  Â updateStarsUI(0);
Â  Â  Â  Â  }
Â  Â  }
Â  Â  async function checkIfStarRated() {
Â  Â  Â  Â  const doc = await db.collection('starRatings').doc(userId).get();
Â  Â  Â  Â  if(doc.exists) {
Â  Â  Â  Â  Â  Â  const userRating = doc.data().rating;
Â  Â  Â  Â  Â  Â  updateStarsUI(userRating);
Â  Â  Â  Â  Â  Â  document.querySelectorAll('.star-btn').forEach(star => star.setAttribute('disabled', true));
Â  Â  Â  Â  }
Â  Â  }
Â  Â  async function handleStarClick(rating) {
Â  Â  Â  Â  const starRatingRef = db.collection('starRatings').doc(userId);
Â  Â  Â  Â  const userRatingDoc = await starRatingRef.get();
Â  Â  Â  Â  if(userRatingDoc.exists) return;

Â  Â  Â  Â  const confirmationMessage = `You are about to submit a rating of ${rating} out of 5. Are you sure?`;
Â  Â  Â  Â  if (confirm(confirmationMessage)) {
Â  Â  Â  Â  Â  Â  const settingsRef = db.collection('settings').doc('starRatingControl');
Â  Â  Â  Â  Â  Â  try {
Â  Â  Â  Â  Â  Â  Â  Â  await db.runTransaction(async (transaction) => {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const settingsDoc = await transaction.get(settingsRef);
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  const { sumOfRatings = 0, totalRatings = 0 } = settingsDoc.data() || {};
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.set(starRatingRef, { rating, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  transaction.set(settingsRef, {
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  sumOfRatings: sumOfRatings + rating,
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  totalRatings: totalRatings + 1
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  }, { merge: true });
Â  _x000D_ Â  Â  Â  Â  Â  Â  });
Â  Â  Â  Â  Â  Â  Â  Â  checkIfStarRated();
Â  Â  Â  Â  Â  Â  Â  Â  loadStarRatingResults();
Â  Â  Â  Â  Â  Â  } catch (e) {
Â  Â  Â  Â  Â  Â  Â  Â  console.error("Transaction failed: ", e);
Â  Â  Â  Â  Â  Â  Â  Â  alert("Could not submit rating. Please try again.");
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  } else {
Â  Â  Â  Â  Â  Â  return;
Â  Â  Â  Â  }
Â  Â  }

Â  Â  // --- ADMIN UTILITIES ---
Â  Â  async function resetData(collectionName, confirmationMsg) {
Â  Â  Â  Â  if (!isAdmin || !confirm(confirmationMsg)) return;
Â  Â  Â  Â  const snapshot = await db.collection(collectionName).get();
Â  Â  Â  Â  if (snapshot.empty) return alert(`No data to delete in ${collectionName}.`);
Â  Â  Â  Â  const batch = db.batch();
Â  Â  Â  Â  snapshot.forEach(doc => batch.delete(doc.ref));
Â  Â  Â  Â  await batch.commit();
Â  Â  Â  Â  alert(`${collectionName} data deleted.`);
Â  Â  }

Â  Â  // --- EVENT LISTENERS ---
Â  Â  document.getElementById('update-item-count').addEventListener('click', async () => {
Â  Â  Â  const count = parseInt(document.getElementById('item-count-input').value, 10);
Â  Â  Â  if (count < 0 || count > 100) return alert("Enter a number between 0 and 100.");
Â  Â  Â  await db.collection('settings').doc('surveySettings').set({ visibleItems: count }, { merge: true });
Â  Â  Â  alert(`Visible items updated to ${count}`);
Â  Â  });
Â  Â  document.getElementById('submit-btn').addEventListener('click', async () => { /* ... survey submit ... */ });
Â  Â  document.getElementById('global-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('submissionControl').set({ enabled: e.target.checked }); });
Â  Â  document.getElementById('emoji-visibility-toggle').addEventListener('change', async (e) => { if (isAdmin) await db.collection('settings').doc('emojiSettings').set({ visible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('star-visibility-toggle').addEventListener('change', async (e) => { if(isAdmin) await db.collection('settings').doc('starRatingControl').set({ visible: e.target.checked }, { merge: true }); });
Â  Â  document.getElementById('reset-btn').addEventListener('click', () => resetData('responses', 'Delete all question data?'));
Â  Â  document.getElementById('reset-emoji-btn').addEventListener('click', () => { resetData('emojiReactions', 'Delete all emoji reactions?').then(loadEmojiResults); });
Â  Â  document.getElementById('reset-stars-btn').addEventListener('click', async () => {
Â  Â  Â  Â  await resetData('starRatings', 'Delete all star ratings?');
Â  Â  Â  Â  await db.collection('settings').doc('starRatingControl').set({ sumOfRatings: 0, totalRatings: 0 }, { merge: true });
Â  Â  Â  Â  updateStarsUI(0); 
Â  Â  Â  Â  loadStarRatingResults();
Â  Â  });
Â  Â  document.querySelectorAll('.emoji-btn').forEach(btn => btn.addEventListener('click', handleEmojiClick));
Â  Â  document.querySelectorAll('.star-btn').forEach(star => {
Â  Â  Â  Â  star.addEventListener('click', (e) => handleStarClick(parseInt(e.target.dataset.rating)));
Â  Â  Â  Â  star.addEventListener('mouseover', (e) => {
Â  Â  Â  Â  Â  Â  if (e.target.hasAttribute('disabled')) return;
Â  Â  Â  Â  Â  Â  updateStarsUI(e.target.dataset.rating);
Â  Â  Â  Â  });
Â  Â  });
Â  Â  document.getElementById('star-options').addEventListener('mouseout', () => {
Â  Â  Â  Â  if (!document.querySelector('.star-btn[disabled]')) {
Â  Â  Â  Â  Â  Â  Â loadStarRatingResults();
Â  Â  Â  Â  }
Â  Â  });

Â  Â  // --- AUTH & INITIALIZATION ---
Â  Â  auth.onAuthStateChanged(async user => {
Â  Â  Â  const adminPanel = document.getElementById('admin-panel');
Â  Â  Â  if (user) {
Â  Â  Â  Â  document.getElementById('login-message').innerText = 'Logged in as ' + user.email;
Â  Â  Â  Â  document.getElementById('login-btn').style.display = 'none';
Â  Â  Â  Â  document.getElementById('logout-btn').style.display = 'inline';
Â  Â  Â  Â  const adminDoc = await db.collection('admins').doc(user.uid).get();
Â  Â  Â  Â  if (adminDoc.exists) {
Â  Â  Â  Â  Â  isAdmin = true;
Â  Â  Â  Â  Â  adminPanel.style.display = 'block';
Â  Â  Â  Â  }
Â  Â  Â  } else {
Â  Â  Â  Â  isAdmin = false;
Â  Â  Â  Â  adminPanel.style.display = 'none';
Â  Â  Â  Â  document.getElementById('login-message').innerText = '';
Â  Â  Â  Â  document.getElementById('login-btn').style.display = 'inline';
Â  Â  Â  Â  document.getElementById('logout-btn').style.display = 'none';
Â  Â  Â  }
Â  Â  });
Â  Â  document.getElementById('login-btn').addEventListener('click', () => auth.signInWithEmailAndPassword(document.getElementById('email').value, document.getElementById('password').value).catch(e => alert("Login failed: " + e.message)));
Â  Â  document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

Â  Â  function setupRealtimeListeners() {
Â  Â  Â  Â  db.collection('settings').doc('surveySettings').onSnapshot(doc => {
Â  Â  Â  Â  Â  Â  const count = (doc.exists && doc.data().visibleItems !== undefined) ? doc.data().visibleItems : 5;
Â  Â  Â  Â  Â  Â  renderSurveyItems(count);
Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('item-count-input').value = count;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  db.collection('settings').doc('emojiSettings').onSnapshot(doc => {
Â  Â  Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
Â  Â  Â  Â  Â  Â  document.getElementById('emoji-container').style.display = visible ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('emoji-visibility-toggle').checked = !!visible;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });

Â  Â  Â  Â  db.collection('settings').doc('starRatingControl').onSnapshot(doc => {
Â  Â  Â  Â  Â  Â  const visible = doc.exists && doc.data().visible;
Â  Â  Â  Â  Â  Â  document.getElementById('star-rating-container').style.display = visible ? 'block' : 'none';
Â  Â  Â  Â  Â  Â  if (isAdmin) {
Â  Â  Â  Â  Â  Â  Â  Â  document.getElementById('star-visibility-toggle').checked = !!visible;
Â  Â  Â  Â  Â  Â  }
Â  Â  Â  Â  });
Â  Â  }

Â  Â  window.onload = () => {
Â  Â  Â  checkIfSubmitted();
Â  Â  Â  showAggregatedResults();
Â  Â  Â  loadEmojiResults();
Â  Â  Â  checkIfReacted();
Â  Â  Â  loadStarRatingResults();
Â  Â  Â  checkIfStarRated();
Â  Â  Â  setupRealtimeListeners();
Â  Â  };

Â  Â  document.getElementById('submit-btn').addEventListener('click', async () => {
Â  Â  Â  const allowed = await isSubmissionEnabled();
Â  Â  Â  if (!allowed) return alert("Submissions are disabled.");
Â  Â  Â  const doc = await db.collection('responses').doc(userId).get();
Â  Â  Â  if (doc.exists) return alert("Already submitted.");
Â  Â  Â  const answers = {};
Â  Â  Â  const items = document.querySelectorAll('.survey-item');
Â  Â  Â  let allAnswered = true;
Â  Â  Â  items.forEach(item => {
Â  Â  Â  Â  const sel = item.querySelector('.btn.selected');
Â  Â  Â  Â  if (sel) answers['item' + item.dataset.item] = sel.dataset.letter; else allAnswered = false;
Â  Â  Â  });
Â  Â  Â  if (items.length > 0 && !allAnswered && !confirm("Some questions are unanswered. Submit anyway?")) return;
Â  Â  Â  await db.collection('responses').doc(userId).set({ answers, timestamp: firebase.firestore.FieldValue.serverTimestamp() });
Â  Â  Â  disableSubmit('Submitted'); alert("Thanks!");
Â  Â  Â  showAggregatedResults();
Â  Â  });
Â  </script>
</body>
</html>
