<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Survey with Admin Control and Reactions</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .btn { padding: 10px 20px; margin: 5px; border:1px solid #444; background:#eee; cursor:pointer; user-select:none; }
    .btn.selected { background:#4CAF50; color:#fff; }
    #submit-btn[disabled] { background:#ccc; color:#666; cursor:not-allowed; }
    #reset-btn, #global-toggle-container, #item-count-container, #reaction-toggle-container { margin-top:20px; display:none; }
    #results { margin-top:30px; padding:15px; background:#f4f4f4; border:1px solid #ccc; white-space:pre-wrap; font-family:monospace; }
    .bar { color:#4CAF50; }
    .highlight { color:#4CAF50; font-weight:bold; }
    .line { border-top:1px solid #ccc; margin:10px 0; }
    .question-title { color: green; font-weight: bold; margin-bottom: 6px; }
    #reaction-section { margin-top: 30px; }
    #reaction-container button { font-size: 20px; }
    #reaction-container button.reaction-btn { margin-right: 10px; cursor: pointer; }
    .reaction-count { margin-left: 6px; font-weight: bold; }
    input[type=number] { width: 60px; padding: 5px; margin-right: 5px; }
  </style>
</head>

<body>
  <img src="RInew.jpg" width="350" height="165" alt="Logo" />

  <!-- Auth Section -->
  <div id="auth-section">
    <input id="email" type="email" placeholder="Admin Email" />
    <input id="password" type="password" placeholder="Password" />
    <button id="login-btn">Login</button>
    <button id="logout-btn" style="display:none;">Logout</button>
    <div id="login-message"></div>
  </div>

  <!-- Admin Controls -->
  <div id="global-toggle-container">
    <label><input type="checkbox" id="global-toggle" /> <strong>Enable Submissions</strong></label>
  </div>

  <div id="reaction-toggle-container">
    <label><input type="checkbox" id="reaction-toggle" /> <strong>Show Reaction Buttons</strong></label>
  </div>

  <div id="item-count-container">
    <label>
      Number of Questions to Show: 
      <input id="item-count-input" type="number" min="1" max="100" value="5" />
    </label>
    <button id="update-items-btn">Update</button>
  </div>

  <button id="reset-btn">Reset All Data (Responses + Reactions)</button>

  <!-- Survey Container -->
  <div id="survey-container"></div>

  <button id="submit-btn">Submit</button>

  <!-- Reaction Buttons Section -->
  <div id="reaction-section" style="display:none;">
    <h3>React to this Survey:</h3>
    <div id="reaction-container">
      <!-- Reaction buttons added by JS -->
    </div>
  </div>

  <!-- Results -->
  <div id="results"></div>

  <script>
    // Firebase configuration (replace with your config)
    const firebaseConfig = {
      apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
      authDomain: "shamankingdata.firebaseapp.com",
      projectId: "shamankingdata",
      storageBucket: "shamankingdata.appspot.com",
      messagingSenderId: "757444066890",
      appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let isAdmin = false;
    const reactionTypes = ['like', 'heart', 'dislike', 'sad', 'happy'];
    const reactionEmojis = {
      like: 'üëç',
      heart: '‚ù§Ô∏è',
      dislike: 'üëé',
      sad: 'üò¢',
      happy: 'üòÄ'
    };

    // Unique user id stored locally
    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }
    const userId = getUserId();

    // Create survey items dynamically
    async function createSurveyItems(count) {
      const container = document.getElementById('survey-container');
      container.innerHTML = ''; // Clear old items
      for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'survey-item';
        div.dataset.item = i;
        div.style.marginBottom = '15px';

        const questionTitle = document.createElement('div');
        questionTitle.className = 'question-title';
        questionTitle.textContent = `Question #${i}`;
        div.appendChild(questionTitle);

        ['A', 'B', 'C', 'D'].forEach(letter => {
          const btn = document.createElement('button');
          btn.className = 'btn';
          btn.dataset.letter = letter;
          btn.textContent = letter;
          btn.addEventListener('click', () => {
            // Deselect all in this question first
            div.querySelectorAll('.btn').forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          });
          div.appendChild(btn);
        });

        container.appendChild(div);
      }
    }

    // Disable or enable submit button
    function disableSubmit(text = 'Already Submitted') {
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.innerText = text;
    }
    function enableSubmit() {
      const btn = document.getElementById('submit-btn');
      btn.disabled = false;
      btn.innerText = 'Submit';
    }

    // Check if submission is enabled globally
    async function isSubmissionEnabled() {
      const doc = await db.collection('settings').doc('submissionControl').get();
      return doc.exists && doc.data().enabled === true;
    }

    // Check if user already submitted and enable/disable submit button
    async function checkIfSubmitted() {
      const allowed = await isSubmissionEnabled();
      if (!allowed) {
        disableSubmit('Submission Disabled');
        return;
      }
      const doc = await db.collection('responses').doc(userId).get();
      if (doc.exists) disableSubmit();
      else enableSubmit();
    }

    // Get visible items count from settings or default 5
    async function getVisibleItemCount() {
      const doc = await db.collection('settings').doc('surveySettings').get();
      if (doc.exists && doc.data().visibleItems) {
        return doc.data().visibleItems;
      }
      return 5;
    }

    // Apply visible items: recreate survey items and show/hide
    async function applyVisibleItems() {
      const count = await getVisibleItemCount();
      await createSurveyItems(count);
    }

    // Submit answers
    document.getElementById('submit-btn').addEventListener('click', async () => {
      const allowed = await isSubmissionEnabled();
      if (!allowed) {
        alert("Submissions are disabled.");
        disableSubmit('Submission Disabled');
        return;
      }
      const doc = await db.collection('responses').doc(userId).get();
      if (doc.exists) {
        alert("Already submitted.");
        disableSubmit();
        return;
      }

      const answers = {};
      const items = document.querySelectorAll('.survey-item');
      let allAnswered = true;
      items.forEach(item => {
        const sel = item.querySelector('.btn.selected');
        if (sel) answers['item' + item.dataset.item] = sel.dataset.letter;
        else allAnswered = false;
      });

      if (!allAnswered) {
        if (!confirm("Some questions are unanswered. Submit anyway?")) return;
      }

      await db.collection('responses').doc(userId).set({
        answers,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      disableSubmit('Submitted');
      alert("Thanks for your submission!");
      await showAggregatedResults();
    });

    // Show aggregated results for answers and reactions
    async function showAggregatedResults() {
      const visibleCount = await getVisibleItemCount();

      // Aggregate survey answers
      const snapshot = await db.collection('responses').get();
      const counts = {};
      for (let i = 1; i <= visibleCount; i++) {
        counts['item' + i] = { A: 0, B: 0, C: 0, D: 0 };
      }
      snapshot.forEach(d => {
        const ans = d.data().answers;
        Object.entries(ans).forEach(([k, v]) => {
          if (counts[k]?.[v] !== undefined) counts[k][v]++;
        });
      });

      let max = 1;
      Object.values(counts).forEach(c => Object.values(c).forEach(v => max = Math.max(max, v)));

      let html = '<h3>Survey Results:</h3><pre>';
      for (let i = 1; i <= visibleCount; i++) {
        const itm = counts['item' + i];
        const m = Math.max(...Object.values(itm));
        html += `Question #${i}:\n`;
        Object.entries(itm).forEach(([ltr, cnt]) => {
          const bar = `<span class="bar">${'‚ñà'.repeat((cnt / max) * 20)}</span>`;
          const disp = cnt === m && cnt > 0 ? `<span class="highlight">${ltr}</span>` : ltr;
          html += `  ${disp}: ${cnt} ${bar}\n`;
        });
        html += '</pre><div class="line"></div><pre>';
      }
      html += '</pre>';

      // Aggregate reactions
      const reactionSnap = await db.collection('reactions').get();
      const reactionCounts = {};
      reactionTypes.forEach(r => reactionCounts[r] = 0);
      reactionSnap.forEach(d => {
        const r = d.data().reaction;
        if (reactionCounts[r] !== undefined) reactionCounts[r]++;
      });

      html += '<h3>Reactions:</h3><pre>';
      let maxReaction = Math.max(...Object.values(reactionCounts), 1);
      reactionTypes.forEach(r => {
        const cnt = reactionCounts[r];
        const bar = '‚ñà'.repeat((cnt / maxReaction) * 20);
        html += `  ${reactionEmojis[r]} ${r}: ${cnt} ${bar}\n`;
      });
      html += '</pre>';

      document.getElementById('results').innerHTML = html;
    }

    // Reaction buttons
    function createReactionButtons() {
      const container = document.getElementById('reaction-container');
      container.innerHTML = '';
      reactionTypes.forEach(r => {
        const btn = document.createElement('button');
        btn.className = 'reaction-btn';
        btn.dataset.reaction = r;
        btn.title = r.charAt(0).toUpperCase() + r.slice(1);
        btn.textContent = reactionEmojis[r];
        container.appendChild(btn);
      });
    }
    createReactionButtons();

    // Reaction click handler
    document.getElementById('reaction-container').addEventListener('click', async e => {
      if (!e.target.classList.contains('reaction-btn')) return;
      const reaction = e.target.dataset.reaction;

      const doc = await db.collection('reactions').doc(userId).get();
      if (doc.exists) {
        alert("You have already reacted.");
        return;
      }
      await db.collection('reactions').doc(userId).set({ reaction });
      alert("Thanks for your reaction!");
      await showAggregatedResults();
    });

    // Load reaction toggle from DB and apply visibility
    async function loadReactionToggle() {
      const doc = await db.collection('settings').doc('reactionControl').get();
      const enabled = doc.exists && doc.data().enabled === true;
      document.getElementById('reaction-toggle').checked = enabled;
      document.getElementById('reaction-section').style.display = enabled ? 'block' : 'none';
    }

    // Admin toggle submission enable/disable
    document.getElementById('global-toggle').addEventListener('change', async e => {
      if (!isAdmin) return;
      await db.collection('settings').doc('submissionControl').set({ enabled: e.target.checked });
      alert('Submissions ' + (e.target.checked ? 'enabled' : 'disabled'));
      checkIfSubmitted();
    });

    // Admin toggle reactions show/hide
    document.getElementById('reaction-toggle').addEventListener('change', async e => {
      if (!isAdmin) return;
      const enabled = e.target.checked;
      await db.collection('settings').doc('reactionControl').set({ enabled });
      document.getElementById('reaction-section').style.display = enabled ? 'block' : 'none';
      alert('Reactions ' + (enabled ? 'enabled' : 'disabled'));
      if (enabled) showAggregatedResults();
    });

    // Admin update number of questions to show
    document.getElementById('update-items-btn').addEventListener('click', async () => {
      if (!isAdmin) return;
      let count = parseInt(document.getElementById('item-count-input').value);
      if (isNaN(count) || count < 1) count = 1;
      else if (count > 100) count = 100;
      await db.collection('settings').doc('surveySettings').set({ visibleItems: count });
      alert(`Showing ${count} questions now.`);
      await applyVisibleItems();
      await showAggregatedResults();
      await checkIfSubmitted();
    });

    // Admin reset all responses and reactions
    document.getElementById('reset-btn').addEventListener('click', async () => {
      if (!isAdmin) return;
      if (!confirm("Delete all responses and reactions? This action cannot be undone.")) return;
      const snapResponses = await db.collection('responses').get();
      const snapReactions = await db.collection('reactions').get();
      const batch = db.batch();
      snapResponses.forEach(d => batch.delete(d.ref));
      snapReactions.forEach(d => batch.delete(d.ref));
      await batch.commit();
      alert("All data deleted.");
      await applyVisibleItems();
      await showAggregatedResults();
      enableSubmit();
    });

    // Firebase auth state change
    auth.onAuthStateChanged(async user => {
      if (user) {
        document.getElementById('login-message').innerText = 'Logged in as ' + user.email;
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'inline';

        // Check if admin by verifying uid in admins collection
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if (adminDoc.exists) {
          isAdmin = true;
          document.getElementById('reset-btn').style.display = 'inline';
          document.getElementById('global-toggle-container').style.display = 'block';
          document.getElementById('item-count-container').style.display = 'block';
          document.getElementById('reaction-toggle-container').style.display = 'block';

          // Load settings and set controls accordingly
          document.getElementById('global-toggle').checked = await isSubmissionEnabled();
          await loadReactionToggle();

          // Load visible items count from DB and set input
          const surveyDoc = await db.collection('settings').doc('surveySettings').get();
          if (surveyDoc.exists) {
            document.getElementById('item-count-input').value = surveyDoc.data().visibleItems || 5;
          }
        } else {
          isAdmin = false;
          document.getElementById('reset-btn').style.display = 'none';
          document.getElementById('global-toggle-container').style.display = 'none';
          document.getElementById('item-count-container').style.display = 'none';
          document.getElementById('reaction-toggle-container').style.display = 'none';
        }
      } else {
        isAdmin = false;
        document.getElementById('login-message').innerText = '';
        document.getElementById('login-btn').style.display = 'inline';
        document.getElementById('logout-btn').style.display = 'none';
        document.getElementById('reset-btn').style.display = 'none';
        document.getElementById('global-toggle-container').style.display = 'none';
        document.getElementById('item-count-container').style.display = 'none';
        document.getElementById('reaction-toggle-container').style.display = 'none';
      }
    });

    // Login button
    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = document.getElementById('email').value.trim();
      const pass = document.getElementById('password').value.trim();
      if (!email || !pass) {
        alert("Please enter email and password.");
        return;
      }
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    });

    // Logout button
    document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

    // Initialize survey on load
    window.onload = async () => {
      await applyVisibleItems();
      await checkIfSubmitted();

      // Show results regardless (admins and users)
      await showAggregatedResults();
    };
  </script>
</body>
</html>
