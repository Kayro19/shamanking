<!-- Your existing HTML stays the same up to the script tag -->

<script>
  const firebaseConfig = {
    apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
    authDomain: "shamankingdata.firebaseapp.com",
    projectId: "shamankingdata",
    storageBucket: "shamankingdata.appspot.com",
    messagingSenderId: "757444066890",
    appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.firestore();

  window.onload = () => {
    if (localStorage.getItem('hasSubmitted')) {
      disableSubmitButton();
    }
  };

  function disableSubmitButton() {
    const btn = document.getElementById('submit-btn');
    btn.disabled = true;
    btn.innerText = 'Already Submitted';
  }

  function enableSubmitButton() {
    const btn = document.getElementById('submit-btn');
    btn.disabled = false;
    btn.innerText = 'Submit';
  }

  document.querySelectorAll('.survey-item').forEach(item => {
    const buttons = item.querySelectorAll('.btn');
    buttons.forEach(button => {
      button.addEventListener('click', () => {
        buttons.forEach(btn => btn.classList.remove('selected'));
        button.classList.add('selected');
      });
    });
  });

  document.getElementById('submit-btn').addEventListener('click', async () => {
    const results = {};
    let allAnswered = true;

    document.querySelectorAll('.survey-item').forEach(item => {
      const selectedBtn = item.querySelector('.btn.selected');
      const itemNum = item.getAttribute('data-item');
      if (selectedBtn) {
        results[`item${itemNum}`] = selectedBtn.getAttribute('data-letter');
      } else {
        allAnswered = false;
      }
    });

    if (!allAnswered) {
      alert('Please answer all questions before submitting.');
      return;
    }

    try {
      // ðŸ”½ Subtract old answers if exist
      const previousAnswers = JSON.parse(localStorage.getItem('previousAnswers'));
      if (previousAnswers) {
        const snapshot = await db.collection('responses').get();
        const updates = [];

        snapshot.forEach(doc => {
          const answers = doc.data().answers;
          const docRef = doc.ref;
          const docData = { ...answers };

          // Check and subtract
          for (const [item, letter] of Object.entries(previousAnswers)) {
            if (docData[item] === letter) {
              updates.push(docRef.delete());
              break; // remove only 1 matching response
            }
          }
        });

        await Promise.all(updates.map(op => op));
      }

      // Save new answers
      await db.collection('responses').add({
        answers: results,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      // Save new answers locally
      localStorage.setItem('previousAnswers', JSON.stringify(results));
      localStorage.setItem('hasSubmitted', 'true');
      disableSubmitButton();

      alert('Thanks for submitting!');
      showAggregatedResults();
    } catch (error) {
      console.error('Error saving response:', error);
      alert('Failed to save your answers. Try again.');
    }
  });

  async function showAggregatedResults() {
    const snapshot = await db.collection('responses').get();

    const counts = {};
    for (let i = 1; i <= 5; i++) {
      counts[`item${i}`] = { A: 0, B: 0, C: 0, D: 0 };
    }

    snapshot.forEach(doc => {
      const answers = doc.data().answers;
      for (const [item, letter] of Object.entries(answers)) {
        if (counts[item] && counts[item][letter] !== undefined) {
          counts[item][letter]++;
        }
      }
    });

    let resultText = '';
    for (let i = 1; i <= 5; i++) {
      const itemCounts = counts[`item${i}`];
      resultText += `Item ${i}:\n`;
      for (const [letter, count] of Object.entries(itemCounts)) {
        resultText += `  ${letter}: ${count}\n`;
      }
      resultText += '\n';
    }

    document.getElementById('results').innerHTML = `<h3>Aggregated Results:</h3><pre>${resultText}</pre>`;
  }

  document.getElementById('reset-btn').addEventListener('click', async () => {
    const confirmed = confirm("Are you sure you want to delete ALL survey data?");
    if (!confirmed) return;

    try {
      const snapshot = await db.collection('responses').get();
      const batch = db.batch();

      snapshot.forEach(doc => {
        batch.delete(doc.ref);
      });

      await batch.commit();

      localStorage.removeItem('hasSubmitted');
      localStorage.removeItem('previousAnswers');
      enableSubmitButton();

      alert('All survey data has been deleted.');
      document.getElementById('results').innerHTML = '';
    } catch (error) {
      console.error('Error deleting data:', error);
      alert('Failed to reset data.');
    }
  });
</script>
