<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Survey with Firebase - Admin Control</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .survey-item { margin-bottom: 20px; }
    .btn {
      padding: 10px 20px;
      margin-right: 8px;
      border: 1px solid #444;
      background-color: #eee;
      cursor: pointer;
      user-select: none;
    }
    .btn.selected {
      background-color: #4CAF50;
      color: white;
      border-color: #4CAF50;
    }
    #submit-btn, #reset-btn, #logout-btn {
      padding: 10px 25px;
      font-size: 16px;
      margin-top: 10px;
      cursor: pointer;
    }
    #submit-btn[disabled] {
      background-color: #ccc;
      color: #666;
      cursor: not-allowed;
    }
    #reset-btn {
      background-color: #e74c3c;
      color: white;
      border: none;
      margin-left: 10px;
    }
    #logout-btn {
      background-color: #555;
      color: white;
      border: none;
      float: right;
    }
    #results {
      margin-top: 30px;
      padding: 15px;
      background: #f4f4f4;
      border: 1px solid #ccc;
      font-family: monospace;
      white-space: pre-wrap;
    }
    .bar { color: #4CAF50; }
    .highlight { color: #4CAF50; font-weight: bold; }
    #survey-section { margin-top: 30px; }
    .admin-section { margin-top: 20px; padding: 10px; background: #eef; }
    .hidden { display: none; }
    #login-box input { padding: 5px; margin-right: 5px; }
  </style>
</head>
<body>

  <h2>REVIEW INNOVATIONS</h2>

  <!-- Auth -->
  <div id="auth-section">
    <div id="login-box">
      <input type="email" id="email" placeholder="Email" />
      <input type="password" id="password" placeholder="Password" />
      <button onclick="login()">Login</button>
    </div>
    <div id="user-box" class="hidden">
      Logged in as: <span id="user-email"></span>
      <button id="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Admin Controls -->
  <div id="admin-controls" class="admin-section hidden">
    <label>
      <input type="checkbox" id="global-toggle" />
      <strong>Enable Submissions</strong>
    </label>
    <button id="reset-btn">Reset All Data</button>
  </div>

  <!-- Survey Section -->
  <div id="survey-section" class="hidden">
    <div class="survey-item" data-item="1"><div>1. Choose one:</div>
      <button class="btn" data-letter="A">A</button>
      <button class="btn" data-letter="B">B</button>
      <button class="btn" data-letter="C">C</button>
      <button class="btn" data-letter="D">D</button>
    </div>
    <div class="survey-item" data-item="2"><div>2. Choose one:</div>
      <button class="btn" data-letter="A">A</button>
      <button class="btn" data-letter="B">B</button>
      <button class="btn" data-letter="C">C</button>
      <button class="btn" data-letter="D">D</button>
    </div>
    <div class="survey-item" data-item="3"><div>3. Choose one:</div>
      <button class="btn" data-letter="A">A</button>
      <button class="btn" data-letter="B">B</button>
      <button class="btn" data-letter="C">C</button>
      <button class="btn" data-letter="D">D</button>
    </div>
    <div class="survey-item" data-item="4"><div>4. Choose one:</div>
      <button class="btn" data-letter="A">A</button>
      <button class="btn" data-letter="B">B</button>
      <button class="btn" data-letter="C">C</button>
      <button class="btn" data-letter="D">D</button>
    </div>
    <div class="survey-item" data-item="5"><div>5. Choose one:</div>
      <button class="btn" data-letter="A">A</button>
      <button class="btn" data-letter="B">B</button>
      <button class="btn" data-letter="C">C</button>
      <button class="btn" data-letter="D">D</button>
    </div>

    <button id="submit-btn">Submit</button>
  </div>

  <div id="results"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
      authDomain: "shamankingdata.firebaseapp.com",
      projectId: "shamankingdata",
      storageBucket: "shamankingdata.appspot.com",
      messagingSenderId: "757444066890",
      appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let currentUser = null;

    function login() {
      const email = document.getElementById('email').value;
      const password = document.getElementById('password').value;
      auth.signInWithEmailAndPassword(email, password)
        .then(userCred => {
          currentUser = userCred.user;
          setupUI();
        })
        .catch(err => alert(err.message));
    }

    function logout() {
      auth.signOut().then(() => location.reload());
    }

    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }

    async function isSubmissionEnabled() {
      const doc = await db.collection('settings').doc('submissionControl').get();
      return doc.exists && doc.data().enabled === true;
    }

    async function checkIfSubmitted() {
      const allowed = await isSubmissionEnabled();
      if (!allowed) {
        disableSubmitButton('Submission Disabled');
        return;
      }

      const userId = getUserId();
      const doc = await db.collection('responses').doc(userId).get();
      if (doc.exists) {
        disableSubmitButton();
      } else {
        enableSubmitButton();
      }
    }

    function disableSubmitButton(text = 'Already Submitted') {
      const btn = document.getElementById('submit-btn');
      btn.disabled = true;
      btn.innerText = text;
    }

    function enableSubmitButton() {
      const btn = document.getElementById('submit-btn');
      btn.disabled = false;
      btn.innerText = 'Submit';
    }

    document.querySelectorAll('.survey-item').forEach(item => {
      const buttons = item.querySelectorAll('.btn');
      buttons.forEach(button => {
        button.addEventListener('click', () => {
          buttons.forEach(btn => btn.classList.remove('selected'));
          button.classList.add('selected');
        });
      });
    });

    document.getElementById('submit-btn').addEventListener('click', async () => {
      if (!(await isSubmissionEnabled())) {
        alert("Submissions are disabled.");
        disableSubmitButton('Submission Disabled');
        return;
      }

      const userId = getUserId();
      const doc = await db.collection('responses').doc(userId).get();
      if (doc.exists) {
        alert("You already submitted.");
        disableSubmitButton();
        return;
      }

      const results = {};
      let allAnswered = true;
      document.querySelectorAll('.survey-item').forEach(item => {
        const selected = item.querySelector('.btn.selected');
        const itemNum = item.getAttribute('data-item');
        if (selected) {
          results[`item${itemNum}`] = selected.getAttribute('data-letter');
        } else {
          allAnswered = false;
        }
      });

      if (!allAnswered) {
        alert("Answer all questions.");
        return;
      }

      await db.collection('responses').doc(userId).set({
        answers: results,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      alert("Thanks for submitting!");
      disableSubmitButton();
      showAggregatedResults();
    });

    async function showAggregatedResults() {
      const snapshot = await db.collection('responses').get();
      const counts = {};
      for (let i = 1; i <= 5; i++) {
        counts[`item${i}`] = { A: 0, B: 0, C: 0, D: 0 };
      }
      snapshot.forEach(doc => {
        const answers = doc.data().answers;
        for (const [item, letter] of Object.entries(answers)) {
          if (counts[item]) counts[item][letter]++;
        }
      });

      let maxCount = 1;
      for (let i = 1; i <= 5; i++) {
        maxCount = Math.max(maxCount, ...Object.values(counts[`item${i}`]));
      }

      let resultText = '';
      for (let i = 1; i <= 5; i++) {
        const itemCounts = counts[`item${i}`];
        const maxItem = Math.max(...Object.values(itemCounts));
        resultText += `Item ${i}:\n`;
        for (const [letter, count] of Object.entries(itemCounts)) {
          const bar = `<span class="bar">${'â–ˆ'.repeat(Math.round((count / maxCount) * 20))}</span>`;
          const highlight = count === maxItem && count > 0 ? `<span class="highlight">${letter}</span>` : letter;
          resultText += `  ${highlight}: ${count} ${bar}\n`;
        }
        resultText += `\n----------------------------------\n`;
      }

      document.getElementById('results').innerHTML = `<h3>Results:</h3><pre>${resultText}</pre>`;
    }

    document.getElementById('global-toggle').addEventListener('change', async (e) => {
      const enabled = e.target.checked;
      await db.collection('settings').doc('submissionControl').set({ enabled });
      alert(`Submissions ${enabled ? 'ENABLED' : 'DISABLED'}`);
      checkIfSubmitted();
    });

    document.getElementById('reset-btn').addEventListener('click', async () => {
      if (!confirm("Delete ALL survey data?")) return;
      const snapshot = await db.collection('responses').get();
      const batch = db.batch();
      snapshot.forEach(doc => batch.delete(doc.ref));
      await batch.commit();
      enableSubmitButton();
      alert("All responses deleted.");
      showAggregatedResults();
    });

    async function setupUI() {
      const user = auth.currentUser;
      if (!user) return;
      currentUser = user;
      document.getElementById('login-box').classList.add('hidden');
      document.getElementById('user-box').classList.remove('hidden');
      document.getElementById('user-email').innerText = user.email;
      document.getElementById('survey-section').classList.remove('hidden');

      const adminDoc = await db.collection('admins').doc(user.uid).get();
      if (adminDoc.exists && adminDoc.data().isAdmin) {
        document.getElementById('admin-controls').classList.remove('hidden');
        const doc = await db.collection('settings').doc('submissionControl').get();
        document.getElementById('global-toggle').checked = doc.exists && doc.data().enabled;
      }

      checkIfSubmitted();
      showAggregatedResults();
    }

    auth.onAuthStateChanged(user => {
      if (user) setupUI();
    });
  </script>
</body>
</html>
