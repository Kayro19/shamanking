
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Survey with Admin Control & Reactions</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .btn { padding: 10px 20px; margin: 5px; border:1px solid #444; background:#eee; cursor:pointer; }
    .btn.selected { background:#4CAF50; color:#fff; }
    #submit-btn[disabled] { background:#ccc; color:#666; cursor:not-allowed; }
    #reset-btn, #global-toggle-container, #item-count-container, #reaction-toggle-container { margin-top:20px; display:none; }
    #results { margin-top:30px; padding:15px; background:#f4f4f4; border:1px solid #ccc; white-space:pre-wrap; font-family:monospace; }
    .bar { color:#4CAF50; }
    .highlight { color:#4CAF50; font-weight:bold; }
    .line { border-top:1px solid #ccc; margin:10px 0; }
    .question-title { color: green; font-weight: bold; }

    .reaction-btn {
      font-size: 24px;
      padding: 10px;
      margin: 5px;
      cursor: pointer;
      background: #eee;
      border: 1px solid #ccc;
    }
    .reaction-btn.selected {
      background: #4CAF50;
      color: white;
    }
  </style>
</head>
<body>
  <img src="RInew.jpg" width="350" height="165" />

  <!-- Auth Section -->
  <div id="auth-section">
    <input id="email" type="email" placeholder="Admin Email"/>
    <input id="password" type="password" placeholder="Password"/>
    <button id="login-btn">Login</button>
    <button id="logout-btn" style="display:none;">Logout</button>
    <div id="login-message"></div>
  </div>

  <!-- Survey -->
  <div id="survey-container"></div>
  <button id="submit-btn">Submit</button>

  <!-- Admin Controls -->
  <button id="reset-btn">Reset All Data</button>
  <div id="global-toggle-container">
    <label><input type="checkbox" id="global-toggle"/> <strong>Enable Submissions</strong></label>
  </div>
  <div id="item-count-container">
    <label><strong>Number of Questions to Show:</strong></label>
    <input type="number" id="item-count-input" min="1" max="100" value="5"/>
    <button id="update-item-count">Update</button>
  </div>
  <div id="reaction-toggle-container">
    <label><input type="checkbox" id="reaction-toggle"/> <strong>Enable Reactions</strong></label>
  </div>

  <!-- Reactions Section -->
  <div id="reaction-section" style="display: none;">
    <h3>React to This Survey:</h3>
    <div id="reaction-container">
      <button class="reaction-btn" data-reaction="üëç">üëç</button>
      <button class="reaction-btn" data-reaction="‚ù§Ô∏è">‚ù§Ô∏è</button>
      <button class="reaction-btn" data-reaction="üò¢">üò¢</button>
      <button class="reaction-btn" data-reaction="üò†">üò†</button>
      <button class="reaction-btn" data-reaction="üôÇ">üôÇ</button>
    </div>
  </div>

  <!-- Results -->
  <div id="results"></div>

  <script>
    const firebaseConfig = {
      apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
      authDomain: "shamankingdata.firebaseapp.com",
      projectId: "shamankingdata",
      storageBucket: "shamankingdata.appspot.com",
      messagingSenderId: "757444066890",
      appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();
    let isAdmin = false;
    const reactionTypes = ['üëç', '‚ù§Ô∏è', 'üò¢', 'üò†', 'üôÇ'];

    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substr(2, 9);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }
    const userId = getUserId();

    function disableSubmit(text = 'Already Submitted') {
      const btn = document.getElementById('submit-btn');
      btn.disabled = true; btn.innerText = text;
    }
    function enableSubmit() {
      const btn = document.getElementById('submit-btn');
      btn.disabled = false; btn.innerText = 'Submit';
    }

    async function isSubmissionEnabled() {
      const doc = await db.collection('settings').doc('submissionControl').get();
      return doc.exists && doc.data().enabled === true;
    }

    async function checkIfSubmitted() {
      const allowed = await isSubmissionEnabled();
      if (!allowed) { disableSubmit('Submission Disabled'); return; }
      const doc = await db.collection('responses').doc(userId).get();
      doc.exists ? disableSubmit() : enableSubmit();
    }

    function renderSurveyItems(count) {
      const container = document.getElementById('survey-container');
      container.innerHTML = '';
      for (let i = 1; i <= count; i++) {
        const div = document.createElement('div');
        div.className = 'survey-item';
        div.dataset.item = i;
        div.innerHTML = `
          <div class="question-title">Question #${i}</div>
          <button class="btn" data-letter="A">A</button>
          <button class="btn" data-letter="B">B</button>
          <button class="btn" data-letter="C">C</button>
          <button class="btn" data-letter="D">D</button>
        `;
        container.appendChild(div);
      }

      document.querySelectorAll('.survey-item').forEach(item => {
        const buttons = item.querySelectorAll('.btn');
        buttons.forEach(btn => {
          btn.addEventListener('click', () => {
            buttons.forEach(b => b.classList.remove('selected'));
            btn.classList.add('selected');
          });
        });
      });
    }

    async function applyVisibleItems() {
      const doc = await db.collection('settings').doc('surveySettings').get();
      const visible = (doc.exists && doc.data().visibleItems) || 5;
      renderSurveyItems(visible);
    }

    document.getElementById('update-item-count').addEventListener('click', async () => {
      const count = parseInt(document.getElementById('item-count-input').value, 10);
      if (count < 1 || count > 100) {
        alert("Enter a number between 1 and 100.");
        return;
      }
      await db.collection('settings').doc('surveySettings').set({ visibleItems: count }, { merge: true });
      alert(`Visible items updated to ${count}`);
      applyVisibleItems();
    });

    document.getElementById('submit-btn').addEventListener('click', async () => {
      const allowed = await isSubmissionEnabled();
      if (!allowed) { alert("Submissions are disabled."); disableSubmit('Submission Disabled'); return; }

      const doc = await db.collection('responses').doc(userId).get();
      if (doc.exists) { alert("Already submitted."); disableSubmit(); return; }

      const answers = {};
      const items = document.querySelectorAll('.survey-item');
      let allAnswered = true;

      items.forEach(item => {
        const sel = item.querySelector('.btn.selected');
        const qNum = item.dataset.item;
        if (sel) answers['item' + qNum] = sel.dataset.letter;
        else allAnswered = false;
      });

      if (!allAnswered && !confirm("Some questions are unanswered. Submit anyway?")) return;

      await db.collection('responses').doc(userId).set({
        answers,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });

      disableSubmit('Submitted'); alert("Thanks!");
      showAggregatedResults();
    });

    async function showAggregatedResults() {
      const settingsDoc = await db.collection('settings').doc('surveySettings').get();
     
      const visibleCount = (settingsDoc.exists && settingsDoc.data().visibleItems) || 5;

      const snapshot = await db.collection('responses').get();
      // Initialize counts for each visible item
      const counts = {};
      for (let i = 1; i <= visibleCount; i++) {
        counts['item' + i] = { A: 0, B: 0, C: 0, D: 0 };
      }
      snapshot.forEach(d => {
        const ans = d.data().answers;
        Object.entries(ans).forEach(([k, v]) => {
          if (counts[k]?.[v] !== undefined) counts[k][v]++;
        });
      });
      let max = 1;
      Object.values(counts).forEach(c =>
        Object.values(c).forEach(v => max = Math.max(max, v))
      );

      let html = '<h3>Results:</h3><pre>';
      for (let i = 1; i <= visibleCount; i++) {
        const itm = counts['item' + i];
        const m = Math.max(...Object.values(itm));
        html += `Question #${i}:\n`;
        Object.entries(itm).forEach(([ltr, cnt]) => {
          const bar = `<span class="bar">${'‚ñà'.repeat((cnt / max) * 20)}</span>`;
          const disp = cnt === m && cnt > 0 ? `<span class="highlight">${ltr}</span>` : ltr;
          html += `  ${disp}: ${cnt} ${bar}\n`;
        });
        html += '</pre><div class="line"></div><pre>';
      }
      html += '</pre>';
      document.getElementById('results').innerHTML = html;

      // Show reactions results
      await showReactionResults();
    }

    // Reaction Handling
    async function showReactionResults() {
      const reactionSection = document.getElementById('reaction-section');
      const reactionContainer = document.getElementById('reaction-container');
      if (reactionSection.style.display === 'none') return; // reactions hidden

      const snapshot = await db.collection('reactions').get();
      // Count reactions
      const counts = {};
      reactionTypes.forEach(r => counts[r] = 0);
      snapshot.forEach(d => {
        const r = d.data().reaction;
        if (counts[r] !== undefined) counts[r]++;
      });

      // Remove old counts (if any)
      reactionContainer.querySelectorAll('.reaction-count').forEach(el => el.remove());

      // Append counts next to buttons
      reactionContainer.querySelectorAll('button.reaction-btn').forEach(btn => {
        const r = btn.dataset.reaction;
        const countSpan = document.createElement('span');
        countSpan.className = 'reaction-count';
        countSpan.style.marginLeft = '6px';
        countSpan.style.fontWeight = 'bold';
        countSpan.textContent = counts[r] || 0;
        btn.appendChild(countSpan);
      });
    }

    async function loadReactionToggle() {
      const doc = await db.collection('settings').doc('reactionControl').get();
      const enabled = doc.exists && doc.data().enabled === true;
      document.getElementById('reaction-toggle').checked = enabled;
      document.getElementById('reaction-section').style.display = enabled ? 'block' : 'none';
    }

    // Reaction button click
    document.getElementById('reaction-container').addEventListener('click', async e => {
      if (!e.target.classList.contains('reaction-btn')) return;
      const reaction = e.target.dataset.reaction;

      const doc = await db.collection('reactions').doc(userId).get();
      if (doc.exists) {
        alert("You have already reacted.");
        return;
      }
      await db.collection('reactions').doc(userId).set({ reaction });
      alert("Thanks for your reaction!");
      await showReactionResults();
    });

    // Admin toggles
    document.getElementById('global-toggle').addEventListener('change', async e => {
      if (!isAdmin) return;
      await db.collection('settings').doc('submissionControl').set({ enabled: e.target.checked });
      alert('Submissions ' + (e.target.checked ? 'enabled' : 'disabled'));
      checkIfSubmitted();
    });

    document.getElementById('reaction-toggle').addEventListener('change', async e => {
      if (!isAdmin) return;
      const enabled = e.target.checked;
      await db.collection('settings').doc('reactionControl').set({ enabled });
      document.getElementById('reaction-section').style.display = enabled ? 'block' : 'none';
      alert('Reactions ' + (enabled ? 'enabled' : 'disabled'));
      if (enabled) showReactionResults();
    });

    document.getElementById('reset-btn').addEventListener('click', async () => {
      if (!confirm("Delete all responses and reactions?")) return;
      const snapResponses = await db.collection('responses').get();
      const snapReactions = await db.collection('reactions').get();
      const batch = db.batch();
      snapResponses.forEach(d => batch.delete(d.ref));
      snapReactions.forEach(d => batch.delete(d.ref));
      await batch.commit();
      enableSubmit();
      document.getElementById('results').innerHTML = '';
      alert("All data deleted.");
    });

    auth.onAuthStateChanged(async user => {
      if (user) {
        document.getElementById('login-message').innerText = 'Logged in as ' + user.email;
        document.getElementById('login-btn').style.display = 'none';
        document.getElementById('logout-btn').style.display = 'inline';
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if (adminDoc.exists) {
          isAdmin = true;
          document.getElementById('reset-btn').style.display = 'inline';
          document.getElementById('global-toggle-container').style.display = 'block';
          document.getElementById('item-count-container').style.display = 'block';
          document.getElementById('reaction-toggle-container').style.display = 'block';

          document.getElementById('global-toggle').checked = await isSubmissionEnabled();
          await loadReactionToggle();

          // Load visible items count from DB and set input
          const surveyDoc = await db.collection('settings').doc('surveySettings').get();
          if (surveyDoc.exists) {
            document.getElementById('item-count-input').value = surveyDoc.data().visibleItems || 5;
          }
        }
      } else {
        document.getElementById('login-message').innerText = '';
        document.getElementById('login-btn').style.display = 'inline';
        document.getElementById('logout-btn').style.display = 'none';
        isAdmin = false;
        document.getElementById('reset-btn').style.display = 'none';
        document.getElementById('global-toggle-container').style.display = 'none';
        document.getElementById('item-count-container').style.display = 'none';
        document.getElementById('reaction-toggle-container').style.display = 'none';
      }
    });

    document.getElementById('login-btn').addEventListener('click', async () => {
      const email = document.getElementById('email').value;
      const pass = document.getElementById('password').value;
      try {
        await auth.signInWithEmailAndPassword(email, pass);
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    });

    document.getElementById('logout-btn').addEventListener('click', () => auth.signOut());

    window.onload = async () => {
      await applyVisibleItems();
      await checkIfSubmitted();
      await showAggregatedResults();
    };
  </script>
</body>
</html>
