<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Survey with Admin Control</title>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>

  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .btn { padding: 10px 20px; margin: 5px; border:1px solid #444; background:#eee; cursor:pointer; }
    .btn.selected { background:#4CAF50; color:#fff; }
    #submit-btn[disabled] { background:#ccc; color:#666; cursor:not-allowed; }
    #reset-btn, #global-toggle-container { margin-top:20px; display:none; }
    #results { margin-top:30px; padding:15px; background:#f4f4f4; border:1px solid #ccc; white-space:pre-wrap; font-family:monospace; }
    .bar { color:#4CAF50; }
    .highlight { color:#4CAF50; font-weight:bold; }
    .line { border-top:1px solid #ccc; margin:10px 0; }
  </style>
</head>
   <img src="RInew.jpg" width="350" height="170" />
<body>
 


  <!-- Auth Section -->
  <div id="auth-section">
    <input id="email" type="email" placeholder="Admin Email"/>
    <input id="password" type="password" placeholder="Password"/>
    <button id="login-btn">Login</button>
    <button id="logout-btn" style="display:none;">Logout</button>
    <div id="login-message"></div>
  </div>
 <h2> </h2>
  <!-- Survey -->
  <div class="survey-item" data-item="1"><div>1. Choose one:</div>
    <button class="btn" data-letter="A">A</button>
    <button class="btn" data-letter="B">B</button>
    <button class="btn" data-letter="C">C</button>
    <button class="btn" data-letter="D">D</button>
  </div>
  <div class="survey-item" data-item="2"><div>2. Choose one:</div>
    <button class="btn" data-letter="A">A</button>
    <button class="btn" data-letter="B">B</button>
    <button class="btn" data-letter="C">C</button>
    <button class="btn" data-letter="D">D</button>
  </div>
  <div class="survey-item" data-item="3"><div>3. Choose one:</div>
    <button class="btn" data-letter="A">A</button>
    <button class="btn" data-letter="B">B</button>
    <button class="btn" data-letter="C">C</button>
    <button class="btn" data-letter="D">D</button>
  </div>
  <div class="survey-item" data-item="4"><div>4. Choose one:</div>
    <button class="btn" data-letter="A">A</button>
    <button class="btn" data-letter="B">B</button>
    <button class="btn" data-letter="C">C</button>
    <button class="btn" data-letter="D">D</button>
  </div>
  <div class="survey-item" data-item="5"><div>5. Choose one:</div>
    <button class="btn" data-letter="A">A</button>
    <button class="btn" data-letter="B">B</button>
    <button class="btn" data-letter="C">C</button>
    <button class="btn" data-letter="D">D</button>
  </div>

  <button id="submit-btn">Submit</button>
  <button id="reset-btn">Reset All Data</button>

  <div id="global-toggle-container">
    <label><input type="checkbox" id="global-toggle"/> <strong>Enable Submissions</strong></label>
  </div>

  <div id="results"></div>

  <script>
    // Config & init
    const firebaseConfig = {
      apiKey: "AIzaSyD_5YgdpDfpa0dJtcfkUii_UjCKO9oF4J0",
      authDomain: "shamankingdata.firebaseapp.com",
      projectId: "shamankingdata",
      storageBucket: "shamankingdata.appspot.com",
      messagingSenderId: "757444066890",
      appId: "1:757444066890:web:e4f9d41e2905e588d930b3"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore(), auth = firebase.auth();
    let isAdmin = false;

    // Get or create local user ID
    function getUserId() {
      let uid = localStorage.getItem('userId');
      if (!uid) {
        uid = 'user_' + Math.random().toString(36).substr(2,9);
        localStorage.setItem('userId', uid);
      }
      return uid;
    }
    const userId = getUserId();

    // Submit button control
    function disableSubmit(text='Already Submitted'){
      const btn=document.getElementById('submit-btn');
      btn.disabled=true; btn.innerText=text;
    }
    function enableSubmit(){
      const btn=document.getElementById('submit-btn');
      btn.disabled=false; btn.innerText='Submit';
    }

    async function isSubmissionEnabled(){
      const doc = await db.collection('settings').doc('submissionControl').get();
      return doc.exists && doc.data().enabled===true;
    }
    async function checkIfSubmitted(){
      const allowed = await isSubmissionEnabled();
      if(!allowed){ disableSubmit('Submission Disabled'); return; }
      const doc = await db.collection('responses').doc(userId).get();
      doc.exists ? disableSubmit() : enableSubmit();
    }

    document.querySelectorAll('.survey-item').forEach(item=>{
      const buttons=item.querySelectorAll('.btn');
      buttons.forEach(btn=>{
        btn.addEventListener('click',()=>{
          buttons.forEach(b=>b.classList.remove('selected'));
          btn.classList.add('selected');
        });
      });
    });

    document.getElementById('submit-btn').addEventListener('click', async ()=>{
      const allowed = await isSubmissionEnabled();
      if(!allowed){ alert("Submissions are disabled."); disableSubmit('Submission Disabled'); return; }
      const doc = await db.collection('responses').doc(userId).get();
      if(doc.exists){ alert("Already submitted."); disableSubmit(); return; }
      const answers = {}, items=document.querySelectorAll('.survey-item');
      let all=true;
      items.forEach(item=>{
        const sel=item.querySelector('.btn.selected');
        if(sel) answers['item'+item.dataset.item]=sel.dataset.letter;
        else all=false;
      });
      if(!all){
        if(!confirm("Some questions are unanswered. Submit anyway?")) return;
      }
      await db.collection('responses').doc(userId).set({
        answers, timestamp: firebase.firestore.FieldValue.serverTimestamp()
      });
      disableSubmit('Submitted'); alert("Thanks!");
      showAggregatedResults();
    });

    async function showAggregatedResults(){
      const snapshot = await db.collection('responses').get();
      const counts={};
      for(let i=1;i<=5;i++) counts['item'+i]={A:0,B:0,C:0,D:0};
      snapshot.forEach(d=>{
        const ans = d.data().answers;
        Object.entries(ans).forEach(([k,v])=>{
          if(counts[k]?.[v]!==undefined) counts[k][v]++;
        });
      });
      let max=1;
      Object.values(counts).forEach(c=>Object.values(c).forEach(v=>max=Math.max(max,v)));

      let html = '<h3>Results:</h3><pre>';
      for(let i=1;i<=5;i++){
        const itm = counts['item'+i];
        const m = Math.max(...Object.values(itm));
        html += `Item ${i}:\n`;
        Object.entries(itm).forEach(([ltr, cnt])=>{
          const bar=`<span class="bar">${'â–ˆ'.repeat((cnt/max)*20)}</span>`;
          const disp = cnt===m&&cnt>0?`<span class="highlight">${ltr}</span>`:ltr;
          html += `  ${disp}: ${cnt} ${bar}\n`;
        });
        html += '</pre><div class="line"></div><pre>';
      }
      html += '</pre>';
      document.getElementById('results').innerHTML = html;
    }

    document.getElementById('global-toggle').addEventListener('change', async e=>{
      if(!isAdmin) return;
      await db.collection('settings').doc('submissionControl').set({enabled:e.target.checked});
      alert('Submissions '+(e.target.checked?'enabled':'disabled'));
      checkIfSubmitted();
    });
    document.getElementById('reset-btn').addEventListener('click', async ()=>{
      if(!confirm("Delete all responses?"))return;
      const snap = await db.collection('responses').get();
      const batch = db.batch();
      snap.forEach(d=>batch.delete(d.ref));
      await batch.commit();
      enableSubmit(); document.getElementById('results').innerHTML='';
      alert("All data deleted.");
    });

    auth.onAuthStateChanged(async user=>{
      if(user){
        document.getElementById('login-message').innerText='Logged in as '+user.email;
        document.getElementById('login-btn').style.display='none';
        document.getElementById('logout-btn').style.display='inline';
        const adminDoc = await db.collection('admins').doc(user.uid).get();
        if(adminDoc.exists){
          isAdmin=true;
          document.getElementById('reset-btn').style.display='inline';
          document.getElementById('global-toggle-container').style.display='block';
          document.getElementById('global-toggle').checked = await isSubmissionEnabled();
        }
      } else {
        document.getElementById('login-message').innerText='';
        document.getElementById('login-btn').style.display='inline';
        document.getElementById('logout-btn').style.display='none';
        isAdmin=false;
        document.getElementById('reset-btn').style.display='none';
        document.getElementById('global-toggle-container').style.display='none';
      }
    });

    document.getElementById('login-btn').addEventListener('click', async ()=>{
      const email=document.getElementById('email').value;
      const pass=document.getElementById('password').value;
      try{ await auth.signInWithEmailAndPassword(email,pass); }
      catch(e){ alert("Login failed: "+e.message); }
    });
    document.getElementById('logout-btn').addEventListener('click', ()=>auth.signOut());

    window.onload = ()=>{
      checkIfSubmitted();
      showAggregatedResults();
    };
  </script>
</body>
</html>
